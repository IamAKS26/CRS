<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | College Recommendation System</title>
  <link rel="stylesheet" href="dashboardstyle.css">
  </head>
<body>

<header class="navbar">
  <div class="container">
    <a href="index.html" class="logo">CollegeFinder</a>
    <nav>
      <ul>
        <li><a href="dashboard.html" class="active">Dashboard</a></li>
        <li><a href="studentprofile.html">My Profile</a></li>
        <li><a href="#" id="logout-btn" class="btn-logout">Logout</a></li>
      </ul>
    </nav>
  </div>
</header>

<main class="dashboard-container">
  <div class="container">
    <div class="dashboard-header">
      <h1>Welcome, <span id="student-name">Student</span>!</h1>
      <p>Click the button below to get college recommendations based on your CET score.</p>
    </div>

    <section class="recommendation-form-section">
      <form id="recommendation-form">
        <button type="submit" class="btn-primary form-submit-btn">Get My Recommendations</button>
      </form>
    </section>

    <section id="results-section" class="results-section">
      <h2>Your Top Recommendations</h2>
      <div id="loading-spinner" class="loading-spinner" style="display: none;"></div>
      <div id="recommendations-grid" class="colleges-grid">
        <p class="placeholder-text">Your recommended colleges will appear here.</p>
      </div>
    </section>
  </div>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("token");
  const studentNameSpan = document.getElementById("student-name");
  const logoutBtn = document.getElementById("logout-btn");
  const form = document.getElementById("recommendation-form");
  const resultsGrid = document.getElementById("recommendations-grid");
  const loadingSpinner = document.getElementById("loading-spinner");

  if (!token) {
    window.location.href = "Student_login.html";
    return;
  }

  const user = JSON.parse(localStorage.getItem("user"));
  if (user) studentNameSpan.textContent = user.name;

  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    window.location.href = "index.html";
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    resultsGrid.innerHTML = "";
    loadingSpinner.style.display = "block";

    try {
      const res = await fetch("http://localhost:8080/api/colleges/recommend", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({})
      });

      const data = await res.json();
      loadingSpinner.style.display = "none";

      if (res.ok && data.length > 0) {
        resultsGrid.innerHTML = data.map(college => {
            let totalSeats = 0;
            const branchesHTML = college.branches.map(branch => {
                totalSeats += branch.seats;
                return `
                        <li class="branch-item">
                            <span>${branch.branchName}</span>
                            <span class="branch-details">Fees: ₹${branch.fees.toLocaleString('en-IN')} | Seats: ${branch.seats}</span>
                        </li>
                `;
            }).join("");

            return `
              <div class="flip-card">
                <div class="flip-card-inner">
                  <div class="flip-card-front">
                    <div class="college-card">
                      <div class="college-card-content">
                          <h3>${college.collegeName}</h3>
                          <p class="location">${college.location}</p>
                      </div>
                      <div class="college-card-footer">
                          <button class="btn-details flip-btn">More Details</button>
                           <a href="${college.officialLink}" class="btn-details btn-link" target="_blank" rel="noopener noreferrer">Official Link</a>
                      </div>
                    </div>
                  </div>
                  <div class="flip-card-back">
                    <div class="college-card">
                      <div class="college-card-header-back">
                          <h4>Branches & Info</h4>
                          <button class="btn-details flip-btn">Back</button>
                      </div>
                      <div class="college-card-content">
                          <ul class="branch-list">
                              ${branchesHTML}
                          </ul>
                          <div class="summary-info">
                              <p><strong>Total Seats:</strong> ${totalSeats}</p>
                          </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
        }).join("");
      } else {
        const errorData = await res.json().catch(() => ({}));
        resultsGrid.innerHTML = `<p class='placeholder-text'>${errorData.message || 'No colleges found. Please update your score in "My Profile".'}</p>`;
      }
    } catch (err) {
      console.error("❌ Error fetching recommendations:", err);
      resultsGrid.innerHTML = "<p class='placeholder-text'>A server error occurred. Please try again later.</p>";
    }
  });
  
  // This event listener handles flipping the card and does not need to be changed.
  resultsGrid.addEventListener('click', (e) => {
    if (e.target.classList.contains('flip-btn')) {
        const cardInner = e.target.closest('.flip-card-inner');
        if (cardInner) {
            cardInner.classList.toggle('is-flipped');
        }
    }
  });
});
</script>

</body>
</html>